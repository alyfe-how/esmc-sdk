# COLONELS - CL Protocol Module
## Atomic Changelog Workflow Execution Protocol

**Version:** ESMC 3.53 (Extracted from COLONELS.md lines 202-373)
**Purpose:** Lazy-load protocol for tasks with ‚â•50 line changes
**Token Cost:** ~3,189 tokens
**Load Trigger:** Changes ‚â•50 lines OR complexity ‚â•40 OR user requests changelog

---

<!-- CL5 - ESMC 3.29 Atomic CL Workflow Enforcement Protocol -->
<!-- EXECUTION PROTOCOL -->
## üÜï ESMC 3.29 - ATOMIC CL WORKFLOW EXECUTION PROTOCOL

**‚ö†Ô∏è MANDATORY PROTOCOL - APPLIES TO ALL CODE CHANGES ‚â•50 LINES**

**üéØ UNIVERSAL RULE:** Embed CL tags DURING presentation, execute writes atomically AFTER user approval

**WHY THIS MATTERS:**
- Sequential CL cleanup (3 tool calls) wastes tokens vs atomic execution (2 parallel calls)
- Forgetting CL tags creates orphaned changes without documentation
- User sees incomplete solution (fix without documentation context)
- Token savings: 33% fewer tool calls + 50-66% fewer conversation turns

---

### **‚ö†Ô∏è YOU MUST EXECUTE THESE STEPS WHEN CHANGES ‚â•50 LINES:**

**PHASE 1: BEFORE Presenting Code to User (NO tool calls yet)**

**1. Calculate CL metadata (MANDATORY):**
   - **Change:** What changed? (1 sentence summary)
   - **Impact:** Performance improvement? Security fix? New feature?
   - **Rationale:** Why was this change needed?
   - **Code Location:** `filename:startLine-endLine`

**2. Use Glob tool (MANDATORY - Execute NOW):**
   ```
   Pattern: .claude/memory/documents/changelogs/{baseFilename}-CL*.md
   Path: C:\10 ESMC SDK\.claude\memory\documents\changelogs
   ```
   - Execute Glob tool with pattern above
   - Count result files (Glob returns array of matching files)
   - Next CL number = count (0-indexed: if 1 file exists = CL0, next is CL1)
   - Example: Glob finds `BRAIN-CL4.md` (count=1) ‚Üí Next is CL5 (NOT CL1)

**2.5 üõë CHECKPOINT: Did you execute Glob tool in step 2?**
   - If NO: Go back and execute Glob NOW
   - If YES: You have correct CL number from count, proceed to step 3

**üö´ DO NOT proceed without executing Glob in step 2 above**

**3. Embed CL tag in code you will present (BEFORE showing to user):**
   - Format: `<!-- CL{number} - {brief change description} -->` (for .md files)
   - Format: `// CL{number} - {brief change description}` (for .js files)
   - Insert at beginning of changed section
   - Example: `<!-- CL5 - Atomic workflow enforcement protocol -->`

**4. Draft CL file content (prepared, not written yet):**

   **PATH CONSTANT (COPY EXACTLY - NO VARIATIONS):**
   ```
   C:\10 ESMC SDK\.claude\memory\documents\changelogs\{baseFilename}-CL{number}.md
   ```

   **‚ùå WRONG PATHS (DO NOT USE):**
   - `C:\10 ESMC SDK\.claude\ESMC Complete\core\...` (manifest directory)
   - `.claude/memory/documents/changelogs/...` (relative path - use absolute)

   **‚úÖ CORRECT EXAMPLE (BRAIN.md, CL5):**
   ```
   C:\10 ESMC SDK\.claude\memory\documents\changelogs\BRAIN-CL5.md
   ```

   **Content to include:**
   - Date, Component, Change, Impact, Rationale, Code Location
   - Keep in memory, DO NOT write yet

**4.5 üõë CHECKPOINT: Does your path match the constant above?**
   - Path MUST start with: `C:\10 ESMC SDK\.claude\memory\documents\changelogs\`
   - Path MUST end with: `{baseFilename}-CL{number}.md`
   - If path doesn't match: FIX IT before proceeding to step 5

**üö´ DO NOT proceed with incorrect path (step 4 above)**

**5. üõë CHECKPOINT: Did you embed CL tag in presented code?**
   - If NO: Go back to step 3 - DO NOT present code without CL tag
   - If YES: Present complete solution to user (fix + CL tag visible)

**üö´ DO NOT present code without CL tag embedded (step 3 above)**

---

<!-- CL7 - Replace manual Edit/Write tools with AEGIS atomicEditWithCL method -->

**PHASE 2: AFTER User Approves (AEGIS Atomic Execution)**

**6. Execute AEGIS atomic CL workflow:**

```javascript
const { AEGISSystem } = require('./.claude/ESMC-Chaos/components/27c20532.js');
const aegis = new AEGISSystem();

const result = await aegis.atomicEditWithCL({
    file_path: '{absolute_path_to_file}',           // e.g., 'C:\\10 ESMC SDK\\.claude\\ESMC Complete\\core\\BRAIN.md'
    old_string: '{exact_string_to_replace}',        // String from PHASE 1 analysis
    new_string: '{new_string_WITH_CL_tag_embedded}', // Includes CL tag from step 3
    change_description: '{what_changed}',            // From step 4 metadata
    user_prompt: '{user_request_context}'            // Original user request
});

// Result: { success: true, clNumber: X, clFilename: 'file-CLX.md', edited: true }
// This single AEGIS method replaces both Edit + Write tool calls atomically
```

**What this does:**
- Atomically executes file edit + CL file creation
- Applies shouldCreateCL() heuristic (auto-detects if CL warranted)
- Inserts inline CL tag at correct location
- Updates ATLAS index for discoverability
- Returns result object with CL number and filename

**7. üõë CHECKPOINT: Did you execute BOTH writes in same message?**
   - If NO: Protocol violation - you executed sequentially
   - If YES: Atomic workflow complete

**üö´ DO NOT execute Edit and Write sequentially - use parallel atomic execution (step 6 above)**

---

### **üö´ PROTOCOL VIOLATIONS (DO NOT DO THESE):**

‚ùå **Presenting code without CL tag embedded** (if changes ‚â•50 lines)
   - User sees incomplete solution
   - Increases orphan risk
   - Violates atomic workflow principle

‚ùå **Sequential execution** (Edit ‚Üí wait ‚Üí Edit CL ‚Üí wait ‚Üí Write CL)
   - Wastes tokens (3 calls instead of 2)
   - Wastes conversation turns
   - Defeats purpose of atomic workflow

‚ùå **Forgetting CL file creation**
   - Inline tag exists but no documentation
   - ATHENA can't retrieve context later
   - Breaks CL Protocol benefits

---

### **Trigger Conditions (When to Apply This Protocol):**

**MANDATORY:**
- Lines changed ‚â• 50
- Complexity score ‚â• 40
- Security-critical changes
- Performance optimizations
- New feature implementations

**OPTIONAL (User Request):**
- User explicitly asks for changelog
- User requests documentation
- Changes are significant but <50 lines

---

### **Token Economics (Why Atomic Matters):**

| Metric | Sequential (Old) | Atomic (New) | Improvement |
|--------|-----------------|--------------|-------------|
| Tool Calls | 3 | 2 | 33% fewer |
| Conversation Turns | 2-3 | 1 | 50-66% fewer |
| CL Tag Timing | AFTER (cleanup) | DURING (presentation) | Zero orphan risk |
| User Approvals | 2 (fix, then CL) | 1 (complete solution) | 50% less friction |

**Net Result:** 40-50% token savings + improved UX + zero manual cleanup

---

**üìã Complete CL Protocol Documentation:** `.claude/memory/documents/colonels/CL-PROTOCOL.md`
- ATHENA Phase 6.5 integration details
- CL numbering system and tag format
- Token efficiency tables and scalability tiers
- AEGIS automation and integration points

---

**END OF CL PROTOCOL MODULE**


<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë ESMC SDK v4.1 ¬© 2025 Abelitie Designs Malaysia    ‚ïë
‚ïë Build: 2025-11-20 | https://esmc-sdk.com                    ‚ïë
‚ïë                                                               ‚ïë
‚ïë ‚ö†Ô∏è  PROPRIETARY SOFTWARE - Licensed, Not Sold                 ‚ïë
‚ïë                                                               ‚ïë
‚ïë ESMC is a commercial AI-powered development framework.        ‚ïë
‚ïë Unauthorized use, copying, or distribution is strictly        ‚ïë
‚ïë prohibited and will be prosecuted to the fullest extent       ‚ïë
‚ïë of applicable law.                                            ‚ïë
‚ïë                                                               ‚ïë
‚ïë If you obtained this without purchase or valid license:       ‚ïë
‚ïë ‚Üí Report to: security@esmc-sdk.com                            ‚ïë
‚ïë ‚Üí Purchase at: https://esmc-sdk.com                           ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->